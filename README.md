# FFmpeg Processing API

A robust, FastAPI-based service designed to process video and audio files dynamically using FFmpeg commands. This project allows users to upload files, apply complex FFmpeg transformations via a flexible command API, and retrieve the processed results immediately.

> [!NOTE]
> **Free to Use & Edit**: This project is open for use and modification.

## ðŸš€ Features

- **Dynamic Processing**: Execute custom FFmpeg commands on uploaded files.
- **Multiple Inputs**: Support for processing multiple input files simultaneously.
- **Bundled Assets**: Includes bundled fonts (e.g., OpenSans) for easy text overlays.
- **Safety Checks**: Basic validation to prevent common command injection attacks (see Security section).
- **Docker Ready**: Fully containerized for easy deployment.
- **Auto-Cleanup**: Temporary sessions are automatically cleaned up after processing.

## ðŸ› ï¸ Setup & Installation

### Option 1: Docker (Recommended)

1.  **Clone the repository**.
2.  **Run with Docker Compose**:
    ```bash
    docker-compose up --build
    ```
3.  The API will be available at `http://localhost:8000`.

### Option 2: Local Development

**Prerequisites**: Python 3.9+ and **FFmpeg** installed on your system path.

1.  **Create a virtual environment**:
    ```bash
    python -m venv .venv
    # Windows
    .venv\Scripts\activate
    # Linux/Mac
    source .venv/bin/activate
    ```
2.  **Install dependencies**:
    ```bash
    pip install -r requirements.txt
    ```
3.  **Run the server**:
    ```bash
    uvicorn main:app --reload
    ```

## âš™ï¸ Configuration

Control the application behavior using environment variables (or `.env` file):

| Variable | Description | Default |
| :--- | :--- | :--- |
| `TEMP_DIR` | Directory for temporary file storage | System Temp |
| `MAX_FILE_SIZE_MB` | Maximum allowed upload size per file (MB) | `500` |
| `FFMPEG_TIMEOUT_SECONDS` | Timeout for FFmpeg operations (seconds) | `300` |

## ðŸ“– Usage Guide

Failed requests return standard HTTP error codes. Successful processing returns the file as a downloadable attachment.

### Endpoint: `POST /process`

**Parameters:**
- `files`: One or more files to upload.
- `command`: The FFmpeg command template.
- `output_extension`: (Optional) Desired output extension (e.g., `.mp4`, `.mp3`).

**Command Placeholders:**
- `{input}`: The first uploaded file.
- `{input2}`, `{input3}`...: Subsequent files.
- `{output}`: The system-generated output path.
- `{font}`: Path to the bundled OpenSans font.

### Examples

**1. Add a Watermark**
```bash
-i {input} -vf drawtext=fontfile={font}:text='MyWatermark':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2 -c:v libx264 {output}
```

**2. Convert to MP4 (Fast)**
```bash
-i {input} -c:v libx264 -preset fast {output}
```

**3. Extract Audio**
```bash
-i {input} -vn -acodec mp3 {output}
```

## âš ï¸ Security Considerations

> [!WARNING]
> This service executes shell commands based on user input.

While basic sanitization is implemented (blocking dangerous characters like `;`, `|`, `` ` ``), this service **should not be exposed publicly** without additional security layers. It is intended for internal use or behind a secure gateway.

## ðŸ”œ Next Steps & Roadmap

To actively improve this project for production use, the following steps are recommended:

-   **Security**: Implement API Key authentication to restrict access.
-   **Async Processing**: Integrate **Celery** with **Redis** to offload long-running encoding tasks to the background, preventing HTTP timeouts.
-   **Storage**: Implement a configurable retention policy for local storage (e.g., keep files for 3 hours) and add optional **S3/Cloud Storage** support for persistence.
-   **API**: Develop an endpoint to **list processed files**, returning metadata such as submission time, processing duration, and current status.
-   **Testing**: Add a comprehensive suite of **Pytest** unit and integration tests.
-   **Observability**: Implement robust structured logging. (Optional: Add Prometheus/Grafana for real-time metrics).

---
*Generated by Antigravity*
